[nodes]
controlplane
node01

---

- name: Encrypt/Decrypt
  hosts: all
  gather_facts: true
  become: true
  tasks:

  - name: Encrypt file
    when: inventory_hostname == "controlplane"
    shell: |
      base64 -w0 /etc/kubernetes/admin.conf
    register: admin_encoded_conf

  - name: "Add Admin Encoded Conf to dummy host"
    add_host:
      name:   "ADMIN_ENCODED_CONF_HOLDER"
      encoded_conf:  "{{ admin_encoded_conf.stdout }}"
    when: inventory_hostname == "controlplane"

  - name: Send kubeconfig to node01
    when: inventory_hostname == "node01"
    shell: |
      echo {{ hostvars['ADMIN_ENCODED_CONF_HOLDER']['hash'] }} | base64 -d > /tmp/admin.conf

  - debug:
      msg:
        - "Admin Encoded Conf: {{ admin_encoded_conf.stdout }}"
    when: inventory_hostname == "controlplane"
